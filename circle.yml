machine:
  services:
    - docker

dependencies:
  cache_directories:
    - "~/.stack"
    - ".stack-work"
    - "~/docker"
    - "~/.centos6-stack"
    - "~/.centos7-stack"
    - "~/.ubuntu-stack"
    - "~/.ubuntui386-stack"
  pre:
    - curl -L https://github.com/commercialhaskell/stack/releases/download/v1.1.2/stack-1.1.2-linux-x86_64.tar.gz | tar zx -C /tmp
    - sudo mv /tmp/stack-1.1.2-linux-x86_64/stack /usr/bin
    - sudo apt-get update; sudo apt-get install --only-upgrade binutils
  override:
    - stack setup
    - rm -fr $(stack path --dist-dir) $(stack path --local-install-root)
    - stack install hlint packdeps cabal-install
    - stack build --fast -j1
    - stack build --fast --test --no-run-tests
    - mkdir -p ~/docker ~/.{centos6,centos7,ubuntu,ubuntui386}-stack
    - chmod +x docker/distro_release/{load-or-build-image,setup-container,build-on-container}.sh
    - ./docker/distro_release/load-or-build-image.sh centos6
    - ./docker/distro_release/load-or-build-image.sh centos7
    - ./docker/distro_release/load-or-build-image.sh ubuntu
    - ./docker/distro_release/load-or-build-image.sh ubuntui386
    - ./docker/distro_release/setup-container.sh centos6
    - ./docker/distro_release/setup-container.sh centos7
    - ./docker/distro_release/setup-container.sh ubuntu
    - ./docker/distro_release/setup-container.sh ubuntui386
    - go get -u github.com/tcnksm/ghr

test:
  override:
    - POSTGREST_TEST_CONNECTION=$(test/create_test_db "postgres://ubuntu@localhost" postgrest_test) stack test
    - test/io-tests.sh
    - git ls-files | grep '\.l\?hs$' | xargs stack exec -- hlint -X QuasiQuotes -X NoPatternSynonyms "$@"
    - stack exec -- cabal update
    - stack exec --no-ghc-package-path -- cabal install --only-d --dry-run
    - stack exec -- packdeps *.cabal || true
    - stack exec -- cabal check
    - stack haddock --no-haddock-deps
    - stack sdist

deployment:
  release:
    tag: /v[0-9]+(\.[0-9]+)*/
    owner: begriffs
    commands:
      - mkdir -p /tmp/bin/{centos6,centos7,ubuntu,ubuntui386}
      - ./docker/distro_release/build-on-container.sh centos6
      - ./docker/distro_release/build-on-container.sh centos7
      - ./docker/distro_release/build-on-container.sh ubuntu
      - ./docker/distro_release/build-on-container.sh ubuntui386
      - |
        cd /tmp/bin &&
        tar cjf postgrest-$CIRCLE_TAG-centos6.tar.xz -C centos6/ postgrest &&
        tar cjf postgrest-$CIRCLE_TAG-centos7.tar.xz -C centos7/ postgrest &&
        tar cjf postgrest-$CIRCLE_TAG-ubuntu.tar.xz -C ubuntu/ postgrest &&
        tar cjf postgrest-$CIRCLE_TAG-ubuntu-x32.tar.xz -C ubuntui386/ postgrest &&
        rm -rf /tmp/bin/{centos6,centos7,ubuntu,ubuntui386}
      - |
        START=$(echo $CIRCLE_TAG | cut -c2-)
        END='## \['
        BODY=$(sed -n "1,/$START/d;/$END/q;p" CHANGELOG.md)
        ghr -t $GITHUB_TOKEN -u $CIRCLE_PROJECT_USERNAME -r $CIRCLE_PROJECT_REPONAME -b "$BODY" --replace $CIRCLE_TAG /tmp/bin/

#
# Dobi build file for self-contained Docker based build system
#

meta:
    project: postgrest
    default: binary


# Mounts -- locations that get mapped into volumes in docker containers during build tasks
mount=source:
    bind: .
    path: "{env.POSTGREST_SRC:/srv/postgrest}"

mount=dist:
    bind: ./.release
    path: "{env.RELEASE_DIR:/.release}"

mount=stack-home:
    bind: ~/.stack
    path: /root/.stack

mount=stack-work:
    bind: ./.stack-work
    path: "{fs.projectdir}/.stack-work"

# Images -- Docker images used in the build or generated by the build
image=builder:
    image: postgrest-builder
    context: dockerfiles/
    dockerfile: Dockerfile.build
    description: "Build environment that compiles the app using stack"

image=dist-img:
    image: begriffs/postgrest
    tags:
        - "{env.POSTGREST_VERSION:0.4.0}"
    context: dockerfiles/
    dockerfile: Dockerfile.dist
    description: "Builds the distribution image"

image=releaser:
    image: postgrest-releaser
    context: dockerfiles/
    dockerfile: Dockerfile.release
    description: "Pushes the built version up to the Github Releases page"


# Jobs -- Specific steps in the build process.  Each happens within its own Docker container
job=binary:
    use: builder
    artifact: ./.release/postgrest
    mounts:
        - source
        - dist
        - stack-work
        - stack-home
    command: scripts/build
    env:
        - "DEBUG={env.DEBUG:false}"
    description: "Build the binary file"

job=shell:
    use: builder
    interactive: true
    provide-docker: true
    mounts:
        - source
        - dist
        - stack-work
        - stack-home
    command: bash
    description: "Start an interactive dev build environment"

job=github-release:
    use: releaser
    mounts: [dist]
    env:
        - "GITHUB_TOKEN={env.GITHUB_TOKEN:}"
        - "POSTGREST_VERSION={env.CIRCLE_TAG:}"

job=release-version:
    use: builder
    mounts: [dist]
    command: "bash -ec \"/bin/postgrest --version\""

job=dependencies:
    use: builder
    mounts:
        - source
        - stack-work
        - stack-home
    command: "/run_stack_deps.sh"
    sources:
        - postgrest.cabal
        - stack.yaml
    artifact: .stack-work/


# Aliases - Like Makefile targets, shortcuts to perform a task or series of tasks
alias=release:
    tasks:
        - 'dependencies'
        - 'binary'
        - 'github-release'
        - 'release-version:capture(POSTGREST_VERSION)'
        - 'dist-img:push'
